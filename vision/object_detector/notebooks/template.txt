async def setup():
    print("Setup completed.")

async def run_command(command: str):
    print(f"Running command: {command}")
    process = await asyncio.create_subprocess_shell(
        command,
        stdout=asyncio.subprocess.PIPE,
        stderr=asyncio.subprocess.STDOUT,
        cwd=workdir
    )
    while True:
        line = await process.stdout.readline()
        if not line:
            break
        line = line.decode().strip()
        print(line)
    await process.wait()
    

async def downloadModels():
    print(os.getcwd())
    await run_command("git clone https://github.com/IDEA-Research/GroundingDINO.git")
    await run_command("wget https://github.com/IDEA-Research/GroundingDINO/releases/download/v0.1.0-alpha/groundingdino_swint_ogc.pth")
    await run_command("wget https://dl.fbaipublicfiles.com/segment_anything/sam_vit_h_4b8939.pth")


import asyncio
from fastapi import FastAPI, WebSocket

FUNCTION_REGISTRY = {
    "setup": setup,
    "crop": crop,
    "resize": resize,
    "segment": segment,
    "crop_precessed": crop_precessed,
    "manually_check": manually_check,
    "downloadModels": downloadModels,
}

app = FastAPI()
active_tasks = {}

async def execute_function(name: str):
    func = FUNCTION_REGISTRY.get(name)

    if not func:
        print(f"'{name}' function not found.")
        return

    print(f"‚ñ∂Ô∏è Executing: {name}")

    try:
        result = func()
        if asyncio.iscoroutine(result):
            await result
        active_tasks.pop(name, None)
        print(f"‚úÖ Finished: {name}")

    except Exception as e:
        print(f"üî• Error in {name}: {str(e)}")

@app.websocket("/ws")
async def ws_endpoint(ws: WebSocket):
    await ws.accept()

    try:
        while True:
            data = json.loads(await ws.receive_text())

            if data["action"] == "run":
                tags = data.get("tags")
                for tag in tags:
                    tag_name = tag.get("name") if isinstance(tag, dict) else tag
                    if not tag_name:
                        continue
                    task = asyncio.create_task(execute_function(tag_name))
                    active_tasks[tag_name] = task

    except Exception:
        pass

if __name__ == '__main__':
    pass